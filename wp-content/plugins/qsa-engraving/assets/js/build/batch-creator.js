(()=>{"use strict";var e,a={754(){const e=window.React,a=window.wp.element,t=window.wp.i18n;function s({state:a}){return"all"===a?(0,e.createElement)("span",{className:"dashicons dashicons-yes-alt"}):"partial"===a?(0,e.createElement)("span",{className:"dashicons dashicons-minus"}):(0,e.createElement)("span",{className:"dashicons dashicons-marker qsa-checkbox-empty"})}function n({module:a,moduleId:s,isSelected:n,engraveQty:l,onToggleSelect:r,onUpdateQty:c}){const{module_sku:o,build_qty:i,qty_received:d,qty_to_engrave:m}=a;return(0,e.createElement)("div",{className:"qsa-module "+(n?"is-selected":"")},(0,e.createElement)("button",{className:"qsa-checkbox qsa-checkbox--"+(n?"all":"none"),onClick:r,"aria-checked":n,"aria-label":(0,t.__)("Select this module","qsa-engraving")},n&&(0,e.createElement)("span",{className:"dashicons dashicons-yes"})),(0,e.createElement)("span",{className:"dashicons dashicons-admin-generic qsa-module-icon"}),(0,e.createElement)("div",{className:"qsa-module-info"},(0,e.createElement)("span",{className:"qsa-module-sku"},o)),(0,e.createElement)("div",{className:"qsa-module-progress"},(0,e.createElement)("span",{className:"qsa-progress-text"},d,"/",i," ",(0,t.__)("complete","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-module-qty"},(0,e.createElement)("input",{type:"number",min:"1",max:m,value:l,onChange:e=>c(e.target.value),className:"qsa-qty-input","aria-label":(0,t.__)("Quantity to engrave","qsa-engraving")}),(0,e.createElement)("span",{className:"qsa-qty-max"},"/ ",m)))}function l({baseType:a,order:l,isExpanded:r,selectionState:c,selectedModules:o,onToggleExpand:i,onToggleSelect:d,onToggleModuleSelect:m,getEngraveQty:u,updateEngraveQty:g}){const p=l.items.length,E=l.total_qty,v="none"!==c;return(0,e.createElement)("div",{className:"qsa-order "+(v?"is-selected":"")},(0,e.createElement)("div",{className:"qsa-order-row"},(0,e.createElement)("button",{className:"qsa-expand-btn",onClick:i,"aria-expanded":r,"aria-label":r?(0,t.__)("Collapse","qsa-engraving"):(0,t.__)("Expand","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons "+(r?"dashicons-arrow-down-alt2":"dashicons-arrow-right-alt2")})),(0,e.createElement)("button",{className:`qsa-checkbox qsa-checkbox--${c}`,onClick:d,"aria-checked":"all"===c,"aria-label":(0,t.__)("Select all modules in this order","qsa-engraving")},(0,e.createElement)(s,{state:c})),(0,e.createElement)("span",{className:"dashicons dashicons-clipboard qsa-order-icon"}),(0,e.createElement)("div",{className:"qsa-order-info",onClick:i},(0,e.createElement)("span",{className:"qsa-order-id"},"#",l.order_id)),(0,e.createElement)("div",{className:"qsa-order-stats"},(0,e.createElement)("span",{className:"qsa-stat-skus"},p," ",1===p?(0,t.__)("SKU","qsa-engraving"):(0,t.__)("SKUs","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-stat-units"},E," ",(0,t.__)("units","qsa-engraving")))),r&&(0,e.createElement)("div",{className:"qsa-modules"},l.items.map(a=>{const t=`${a.production_batch_id}-${a.module_sku}-${a.order_id}`;return(0,e.createElement)(n,{key:t,module:a,moduleId:t,isSelected:o.has(t),engraveQty:u(t,a.qty_to_engrave),onToggleSelect:()=>m(t),onUpdateQty:e=>g(t,e,a.qty_to_engrave)})})))}function r({baseType:a,baseTypeName:n,data:r,isExpanded:c,selectionState:o,expandedOrders:i,selectedModules:d,getOrderSelectionState:m,onToggleExpand:u,onToggleSelect:g,onToggleOrderExpand:p,onToggleOrderSelect:E,onToggleModuleSelect:v,getEngraveQty:_,updateEngraveQty:q,isLast:h}){const b=r.order_count||r.modules.length,y=r.total_qty,N="none"!==o;return(0,e.createElement)("div",{className:`qsa-base-type ${N?"is-selected":""} ${h?"is-last":""}`},(0,e.createElement)("div",{className:"qsa-base-type-row"},(0,e.createElement)("button",{className:"qsa-expand-btn",onClick:u,"aria-expanded":c,"aria-label":c?(0,t.__)("Collapse","qsa-engraving"):(0,t.__)("Expand","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons "+(c?"dashicons-arrow-down-alt2":"dashicons-arrow-right-alt2")})),(0,e.createElement)("button",{className:`qsa-checkbox qsa-checkbox--${o}`,onClick:g,"aria-checked":"all"===o,"aria-label":(0,t.__)("Select all modules in this base type","qsa-engraving")},(0,e.createElement)(s,{state:o})),(0,e.createElement)("div",{className:"qsa-base-type-info",onClick:u},(0,e.createElement)("span",{className:"qsa-base-type-code"},a),(0,e.createElement)("span",{className:"qsa-base-type-name"},n)),(0,e.createElement)("div",{className:"qsa-base-type-stats"},(0,e.createElement)("span",{className:"qsa-stat-orders"},b," ",1===b?(0,t.__)("order","qsa-engraving"):(0,t.__)("orders","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-stat-units"},y," ",(0,t.__)("units","qsa-engraving")))),c&&(0,e.createElement)("div",{className:"qsa-orders"},r.modules.map(t=>(0,e.createElement)(l,{key:t.order_id,baseType:a,order:t,isExpanded:i.has(t.order_id),selectionState:m(a,t.order_id),selectedModules:d,onToggleExpand:()=>p(t.order_id),onToggleSelect:()=>E(t.order_id),onToggleModuleSelect:v,getEngraveQty:_,updateEngraveQty:q}))))}function c({moduleData:a,baseTypeNames:s,selectedModules:n,expandedBaseTypes:l,expandedOrders:c,getBaseTypeSelectionState:o,getOrderSelectionState:i,toggleBaseTypeExpansion:d,toggleOrderExpansion:m,toggleBaseTypeSelection:u,toggleOrderSelection:g,toggleModuleSelection:p,getEngraveQty:E,updateEngraveQty:v}){const _=Object.keys(a);return(0,e.createElement)("div",{className:"qsa-module-tree"},(0,e.createElement)("div",{className:"qsa-tree-header"},(0,e.createElement)("span",{className:"qsa-tree-header-text"},(0,t.__)("Modules Awaiting Engraving","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-tree-body"},_.map((t,q)=>(0,e.createElement)(r,{key:t,baseType:t,baseTypeName:s[t]||t,data:a[t],isExpanded:l.has(t),selectionState:o(t),expandedOrders:c,selectedModules:n,getOrderSelectionState:i,onToggleExpand:()=>d(t),onToggleSelect:()=>u(t),onToggleOrderExpand:m,onToggleOrderSelect:e=>g(t,e),onToggleModuleSelect:p,getEngraveQty:E,updateEngraveQty:v,isLast:q===_.length-1}))))}function o({baseTypeCount:a,selectedCount:s,unitCount:n,previewData:l}){return(0,e.createElement)("div",{className:"qsa-stats-bar"},(0,e.createElement)("div",{className:"qsa-stat"},(0,e.createElement)("span",{className:"qsa-stat-value"},a),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("Base Types","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-stat"},(0,e.createElement)("span",{className:"qsa-stat-value"},s),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("Selected SKUs","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-stat"},(0,e.createElement)("span",{className:"qsa-stat-value"},n),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("Total Units","qsa-engraving"))),l&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("div",{className:"qsa-stat qsa-stat-preview"},(0,e.createElement)("span",{className:"qsa-stat-value"},l.array_count||0),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("QSA Arrays","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-stat qsa-stat-preview"},(0,e.createElement)("span",{className:"qsa-stat-value"},l.led_transitions||0),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("LED Transitions","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-stat qsa-stat-preview"},(0,e.createElement)("span",{className:"qsa-stat-value"},l.distinct_leds?.length||0),(0,e.createElement)("span",{className:"qsa-stat-label"},(0,t.__)("Distinct LEDs","qsa-engraving")))))}function i({hasSelection:a,moduleCount:s,unitCount:n,onClear:l,onPreview:r,onCreateBatch:c,creating:o,previewing:i,onRefresh:d}){return a?(0,e.createElement)("div",{className:"qsa-action-bar qsa-action-bar--selected"},(0,e.createElement)("div",{className:"qsa-action-info"},(0,e.createElement)("span",{className:"dashicons dashicons-yes-alt qsa-action-icon"}),(0,e.createElement)("span",{className:"qsa-action-text"},s," ",1===s?(0,t.__)("module","qsa-engraving"):(0,t.__)("modules","qsa-engraving")," ",(0,t.__)("ready for engraving","qsa-engraving")," ","(",n," ",(0,t.__)("units","qsa-engraving"),")")),(0,e.createElement)("div",{className:"qsa-action-buttons"},(0,e.createElement)("button",{className:"button qsa-btn-clear",onClick:l,disabled:o||i},(0,t.__)("Clear Selection","qsa-engraving")),(0,e.createElement)("button",{className:"button qsa-btn-preview",onClick:r,disabled:o||i,title:(0,t.__)("Preview LED transitions and array breakdown","qsa-engraving")},i?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("span",{className:"spinner is-active"}),(0,t.__)("Previewing...","qsa-engraving")):(0,e.createElement)(e.Fragment,null,(0,e.createElement)("span",{className:"dashicons dashicons-visibility"}),(0,t.__)("Preview","qsa-engraving"))),(0,e.createElement)("button",{className:"button button-primary qsa-btn-create",onClick:c,disabled:o||i},o?(0,e.createElement)(e.Fragment,null,(0,e.createElement)("span",{className:"spinner is-active"}),(0,t.__)("Creating...","qsa-engraving")):(0,e.createElement)(e.Fragment,null,(0,t.__)("Start Engraving","qsa-engraving"),(0,e.createElement)("span",{className:"dashicons dashicons-arrow-right-alt"}))))):(0,e.createElement)("div",{className:"qsa-action-bar"},(0,e.createElement)("div",{className:"qsa-action-info"},(0,e.createElement)("span",{className:"dashicons dashicons-list-view qsa-action-icon"}),(0,e.createElement)("span",{className:"qsa-action-text"},(0,t.__)("Modules Awaiting Engraving","qsa-engraving"))),(0,e.createElement)("button",{className:"button qsa-btn-refresh",onClick:d,title:(0,t.__)("Refresh module list","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons dashicons-update"})))}const d={SOLO:"Star/O",CORE:"LUXEON C ES",EDGE:"LUXEON UV U1",STAR:"Cree XPG",NORD:"Nordic",ATOM:"Atomic",APEX:"Apex",PICO:"Pico",QUAD:"Quad"};function m(){const[s,n]=(0,a.useState)({}),[l,r]=(0,a.useState)(!0),[m,u]=(0,a.useState)(null),[g,p]=(0,a.useState)(new Set),[E,v]=(0,a.useState)({}),[_,q]=(0,a.useState)(new Set),[h,b]=(0,a.useState)(new Set),[y,N]=(0,a.useState)(!1),[S,w]=(0,a.useState)(null),[f,C]=(0,a.useState)(!1),k=async(e,a={})=>{const t=new FormData;return t.append("action",e),t.append("nonce",window.qsaEngraving?.nonce||""),Object.entries(a).forEach(([e,a])=>{t.append(e,"object"==typeof a?JSON.stringify(a):a)}),(await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:t,credentials:"same-origin"})).json()},x=(0,a.useCallback)(async()=>{r(!0),u(null),w(null);try{const e=await k("qsa_get_modules_awaiting");e.success&&e.data?n(e.data):u(e.message||(0,t.__)("Failed to load modules.","qsa-engraving"))}catch(e){u((0,t.__)("Failed to connect to server.","qsa-engraving"))}finally{r(!1)}},[]);(0,a.useEffect)(()=>{x()},[x]);const T=(0,a.useMemo)(()=>{const e=[];return Object.values(s).forEach(a=>{a.modules.forEach(a=>{a.items.forEach(a=>{const t=`${a.production_batch_id}-${a.module_sku}-${a.order_id}`;e.push({id:t,module:a})})})}),e},[s]),O=(0,a.useCallback)(e=>{const a=new Set;return s[e]&&s[e].modules.forEach(e=>{e.items.forEach(e=>{a.add(`${e.production_batch_id}-${e.module_sku}-${e.order_id}`)})}),a},[s]),M=(0,a.useCallback)((e,a)=>{const t=new Set;if(s[e]){const n=s[e].modules.find(e=>e.order_id===a);n&&n.items.forEach(e=>{t.add(`${e.production_batch_id}-${e.module_sku}-${e.order_id}`)})}return t},[s]),Q=(0,a.useCallback)(e=>{const a=O(e),t=[...a].filter(e=>g.has(e)).length;return 0===t?"none":t===a.size?"all":"partial"},[O,g]),$=(0,a.useCallback)((e,a)=>{const t=M(e,a),s=[...t].filter(e=>g.has(e)).length;return 0===s?"none":s===t.size?"all":"partial"},[M,g]),P=(0,a.useCallback)(e=>{q(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t})},[]),D=(0,a.useCallback)(e=>{b(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t})},[]),j=(0,a.useCallback)(e=>{const a=O(e),t=Q(e),n=new Set(g);if("all"===t)a.forEach(e=>n.delete(e));else if(a.forEach(e=>n.add(e)),q(a=>new Set([...a,e])),s[e]){const a=s[e].modules.map(e=>e.order_id);b(e=>new Set([...e,...a]))}p(n),w(null)},[O,Q,s,g]),B=(0,a.useCallback)((e,a)=>{const t=M(e,a),s=$(e,a),n=new Set(g);"all"===s?t.forEach(e=>n.delete(e)):t.forEach(e=>n.add(e)),p(n),w(null)},[M,$,g]),F=(0,a.useCallback)(e=>{p(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t}),w(null)},[]),U=(0,a.useCallback)((e,a)=>void 0!==E[e]?E[e]:a,[E]),L=(0,a.useCallback)((e,a,t)=>{const s=parseInt(a,10)||1,n=Math.max(1,Math.min(s,t));v(a=>({...a,[e]:n})),g.has(e)||p(a=>new Set([...a,e])),w(null)},[g]),A=(0,a.useCallback)(()=>{p(new Set),v({}),w(null)},[]),R=(0,a.useCallback)(()=>{const e=[];return T.forEach(({id:a,module:t})=>{g.has(a)&&e.push({production_batch_id:t.production_batch_id,module_sku:t.module_sku,order_id:t.order_id,quantity:U(a,t.qty_to_engrave)})}),e},[T,g,U]),I=(0,a.useMemo)(()=>{let e=0,a=0;return T.forEach(({id:t,module:s})=>{g.has(t)&&(e++,a+=U(t,s.qty_to_engrave))}),{moduleCount:e,unitCount:a}},[T,g,U]),X=(0,a.useCallback)(async()=>{if(0!==I.moduleCount){C(!0),u(null);try{const e=await k("qsa_preview_batch",{selections:R(),start_position:1});if(console.log("Preview response:",e),e.success&&e.data)w(e.data);else{const a=e.message||e.data?.message||(0,t.__)("Failed to preview batch.","qsa-engraving");u(a)}}catch(e){console.error("Preview error:",e),u((0,t.__)("Failed to preview batch.","qsa-engraving")+" "+(e.message||""))}finally{C(!1)}}},[I,R]),z=(0,a.useCallback)(async()=>{if(0!==I.moduleCount){N(!0);try{const e=await k("qsa_create_batch",{selections:R()});e.success?e.data?.redirect_url?window.location.href=e.data.redirect_url:(A(),x()):u(e.message||(0,t.__)("Failed to create batch.","qsa-engraving"))}catch(e){u((0,t.__)("Failed to create batch. Please try again.","qsa-engraving"))}finally{N(!1)}}},[I,R,A,x]);if(l)return(0,e.createElement)("div",{className:"qsa-batch-creator qsa-loading"},(0,e.createElement)("span",{className:"spinner is-active"}),(0,e.createElement)("p",null,(0,t.__)("Loading modules...","qsa-engraving")));if(m)return(0,e.createElement)("div",{className:"qsa-batch-creator qsa-error"},(0,e.createElement)("div",{className:"notice notice-error",style:{padding:"12px 20px"}},(0,e.createElement)("p",{style:{margin:0,fontSize:"14px",color:"#721c24"}},(0,e.createElement)("strong",null,(0,t.__)("Error:","qsa-engraving"))," ",m)),(0,e.createElement)("button",{className:"button",onClick:()=>{u(null),x()}},(0,t.__)("Retry","qsa-engraving")));const K=Object.keys(s).length>0;return(0,e.createElement)("div",{className:"qsa-batch-creator"},(0,e.createElement)(o,{baseTypeCount:Object.keys(s).length,selectedCount:I.moduleCount,unitCount:I.unitCount,previewData:S}),(0,e.createElement)(i,{hasSelection:I.moduleCount>0,moduleCount:I.moduleCount,unitCount:I.unitCount,onClear:A,onPreview:X,onCreateBatch:z,creating:y,previewing:f,onRefresh:x}),K?(0,e.createElement)(c,{moduleData:s,baseTypeNames:d,selectedModules:g,expandedBaseTypes:_,expandedOrders:h,getBaseTypeSelectionState:Q,getOrderSelectionState:$,toggleBaseTypeExpansion:P,toggleOrderExpansion:D,toggleBaseTypeSelection:j,toggleOrderSelection:B,toggleModuleSelection:F,getEngraveQty:U,updateEngraveQty:L}):(0,e.createElement)("div",{className:"qsa-empty-state"},(0,e.createElement)("p",null,(0,t.__)("No modules awaiting engraving.","qsa-engraving")),(0,e.createElement)("button",{className:"button",onClick:x},(0,t.__)("Refresh","qsa-engraving"))))}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("qsa-engraving-batch-creator");t&&(0,a.createRoot)(t).render((0,e.createElement)(m,null))})}},t={};function s(e){var n=t[e];if(void 0!==n)return n.exports;var l=t[e]={exports:{}};return a[e](l,l.exports,s),l.exports}s.m=a,e=[],s.O=(a,t,n,l)=>{if(!t){var r=1/0;for(d=0;d<e.length;d++){for(var[t,n,l]=e[d],c=!0,o=0;o<t.length;o++)(!1&l||r>=l)&&Object.keys(s.O).every(e=>s.O[e](t[o]))?t.splice(o--,1):(c=!1,l<r&&(r=l));if(c){e.splice(d--,1);var i=n();void 0!==i&&(a=i)}}return a}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[t,n,l]},s.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),(()=>{var e={218:0,653:0};s.O.j=a=>0===e[a];var a=(a,t)=>{var n,l,[r,c,o]=t,i=0;if(r.some(a=>0!==e[a])){for(n in c)s.o(c,n)&&(s.m[n]=c[n]);if(o)var d=o(s)}for(a&&a(t);i<r.length;i++)l=r[i],s.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return s.O(d)},t=globalThis.webpackChunkqsa_engraving=globalThis.webpackChunkqsa_engraving||[];t.forEach(a.bind(null,0)),t.push=a.bind(null,t.push.bind(t))})();var n=s.O(void 0,[653],()=>s(754));n=s.O(n)})();