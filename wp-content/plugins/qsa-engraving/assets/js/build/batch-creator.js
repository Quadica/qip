(()=>{"use strict";var e,a={198(e,a,t){const n=window.React,s=window.wp.element,l=window.wp.i18n,r=window.wp.apiFetch;var o=t.n(r);function c({state:e}){return"all"===e?(0,n.createElement)("span",{className:"dashicons dashicons-yes-alt"}):"partial"===e?(0,n.createElement)("span",{className:"dashicons dashicons-minus"}):(0,n.createElement)("span",{className:"dashicons dashicons-marker qsa-checkbox-empty"})}function i({module:e,moduleId:a,isSelected:t,engraveQty:s,onToggleSelect:r,onUpdateQty:o}){const{module_sku:c,build_qty:i,qty_received:d,qty_to_engrave:m}=e;return(0,n.createElement)("div",{className:"qsa-module "+(t?"is-selected":"")},(0,n.createElement)("button",{className:"qsa-checkbox qsa-checkbox--"+(t?"all":"none"),onClick:r,"aria-checked":t,"aria-label":(0,l.__)("Select this module","qsa-engraving")},t&&(0,n.createElement)("span",{className:"dashicons dashicons-yes"})),(0,n.createElement)("span",{className:"dashicons dashicons-admin-generic qsa-module-icon"}),(0,n.createElement)("div",{className:"qsa-module-info"},(0,n.createElement)("span",{className:"qsa-module-sku"},c)),(0,n.createElement)("div",{className:"qsa-module-progress"},(0,n.createElement)("span",{className:"qsa-progress-text"},d,"/",i," ",(0,l.__)("complete","qsa-engraving"))),(0,n.createElement)("div",{className:"qsa-module-qty"},(0,n.createElement)("input",{type:"number",min:"0",max:m,value:s,onChange:e=>o(e.target.value),className:"qsa-qty-input","aria-label":(0,l.__)("Quantity to engrave","qsa-engraving")}),(0,n.createElement)("span",{className:"qsa-qty-max"},"/ ",m)))}function d({baseType:e,order:a,isExpanded:t,selectionState:s,selectedModules:r,onToggleExpand:o,onToggleSelect:d,onToggleModuleSelect:m,getEngraveQty:u,updateEngraveQty:g}){const p=a.items.length,E=a.total_qty,v="none"!==s;return(0,n.createElement)("div",{className:"qsa-order "+(v?"is-selected":"")},(0,n.createElement)("div",{className:"qsa-order-row"},(0,n.createElement)("button",{className:"qsa-expand-btn",onClick:o,"aria-expanded":t,"aria-label":t?(0,l.__)("Collapse","qsa-engraving"):(0,l.__)("Expand","qsa-engraving")},(0,n.createElement)("span",{className:"dashicons "+(t?"dashicons-arrow-down-alt2":"dashicons-arrow-right-alt2")})),(0,n.createElement)("button",{className:`qsa-checkbox qsa-checkbox--${s}`,onClick:d,"aria-checked":"all"===s,"aria-label":(0,l.__)("Select all modules in this order","qsa-engraving")},(0,n.createElement)(c,{state:s})),(0,n.createElement)("span",{className:"dashicons dashicons-clipboard qsa-order-icon"}),(0,n.createElement)("div",{className:"qsa-order-info",onClick:o},(0,n.createElement)("span",{className:"qsa-order-id"},"#",a.order_id)),(0,n.createElement)("div",{className:"qsa-order-stats"},(0,n.createElement)("span",{className:"qsa-stat-skus"},p," ",1===p?(0,l.__)("SKU","qsa-engraving"):(0,l.__)("SKUs","qsa-engraving")),(0,n.createElement)("span",{className:"qsa-stat-units"},E," ",(0,l.__)("units","qsa-engraving")))),t&&(0,n.createElement)("div",{className:"qsa-modules"},a.items.map(e=>{const a=`${e.production_batch_id}-${e.module_sku}-${e.order_id}`;return(0,n.createElement)(i,{key:a,module:e,moduleId:a,isSelected:r.has(a),engraveQty:u(a,e.qty_to_engrave),onToggleSelect:()=>m(a),onUpdateQty:t=>g(a,t,e.qty_to_engrave)})})))}function m({baseType:e,baseTypeName:a,data:t,isExpanded:s,selectionState:r,expandedOrders:o,selectedModules:i,getOrderSelectionState:m,onToggleExpand:u,onToggleSelect:g,onToggleOrderExpand:p,onToggleOrderSelect:E,onToggleModuleSelect:v,getEngraveQty:_,updateEngraveQty:q,isLast:h}){const b=t.order_count||t.modules.length,y=t.total_qty,N="none"!==r;return(0,n.createElement)("div",{className:`qsa-base-type ${N?"is-selected":""} ${h?"is-last":""}`},(0,n.createElement)("div",{className:"qsa-base-type-row"},(0,n.createElement)("button",{className:"qsa-expand-btn",onClick:u,"aria-expanded":s,"aria-label":s?(0,l.__)("Collapse","qsa-engraving"):(0,l.__)("Expand","qsa-engraving")},(0,n.createElement)("span",{className:"dashicons "+(s?"dashicons-arrow-down-alt2":"dashicons-arrow-right-alt2")})),(0,n.createElement)("button",{className:`qsa-checkbox qsa-checkbox--${r}`,onClick:g,"aria-checked":"all"===r,"aria-label":(0,l.__)("Select all modules in this base type","qsa-engraving")},(0,n.createElement)(c,{state:r})),(0,n.createElement)("div",{className:"qsa-base-type-info",onClick:u},(0,n.createElement)("span",{className:"qsa-base-type-code"},e),(0,n.createElement)("span",{className:"qsa-base-type-name"},a)),(0,n.createElement)("div",{className:"qsa-base-type-stats"},(0,n.createElement)("span",{className:"qsa-stat-orders"},b," ",1===b?(0,l.__)("order","qsa-engraving"):(0,l.__)("orders","qsa-engraving")),(0,n.createElement)("span",{className:"qsa-stat-units"},y," ",(0,l.__)("units","qsa-engraving")))),s&&(0,n.createElement)("div",{className:"qsa-orders"},t.modules.map(a=>(0,n.createElement)(d,{key:a.order_id,baseType:e,order:a,isExpanded:o.has(a.order_id),selectionState:m(e,a.order_id),selectedModules:i,onToggleExpand:()=>p(a.order_id),onToggleSelect:()=>E(a.order_id),onToggleModuleSelect:v,getEngraveQty:_,updateEngraveQty:q}))))}function u({moduleData:e,baseTypeNames:a,selectedModules:t,expandedBaseTypes:s,expandedOrders:r,getBaseTypeSelectionState:o,getOrderSelectionState:c,toggleBaseTypeExpansion:i,toggleOrderExpansion:d,toggleBaseTypeSelection:u,toggleOrderSelection:g,toggleModuleSelection:p,getEngraveQty:E,updateEngraveQty:v}){const _=Object.keys(e);return(0,n.createElement)("div",{className:"qsa-module-tree"},(0,n.createElement)("div",{className:"qsa-tree-header"},(0,n.createElement)("span",{className:"qsa-tree-header-text"},(0,l.__)("Modules Awaiting Engraving","qsa-engraving"))),(0,n.createElement)("div",{className:"qsa-tree-body"},_.map((l,q)=>(0,n.createElement)(m,{key:l,baseType:l,baseTypeName:a[l]||l,data:e[l],isExpanded:s.has(l),selectionState:o(l),expandedOrders:r,selectedModules:t,getOrderSelectionState:c,onToggleExpand:()=>i(l),onToggleSelect:()=>u(l),onToggleOrderExpand:d,onToggleOrderSelect:e=>g(l,e),onToggleModuleSelect:p,getEngraveQty:E,updateEngraveQty:v,isLast:q===_.length-1}))))}function g({baseTypeCount:e,selectedCount:a,unitCount:t}){return(0,n.createElement)("div",{className:"qsa-stats-bar"},(0,n.createElement)("div",{className:"qsa-stat"},(0,n.createElement)("span",{className:"qsa-stat-value"},e),(0,n.createElement)("span",{className:"qsa-stat-label"},(0,l.__)("Base Types","qsa-engraving"))),(0,n.createElement)("div",{className:"qsa-stat"},(0,n.createElement)("span",{className:"qsa-stat-value"},a),(0,n.createElement)("span",{className:"qsa-stat-label"},(0,l.__)("Selected SKUs","qsa-engraving"))),(0,n.createElement)("div",{className:"qsa-stat"},(0,n.createElement)("span",{className:"qsa-stat-value"},t),(0,n.createElement)("span",{className:"qsa-stat-label"},(0,l.__)("Total Units","qsa-engraving"))))}function p({hasSelection:e,moduleCount:a,unitCount:t,onClear:s,onCreateBatch:r,creating:o,onRefresh:c}){return e?(0,n.createElement)("div",{className:"qsa-action-bar qsa-action-bar--selected"},(0,n.createElement)("div",{className:"qsa-action-info"},(0,n.createElement)("span",{className:"dashicons dashicons-yes-alt qsa-action-icon"}),(0,n.createElement)("span",{className:"qsa-action-text"},a," ",1===a?(0,l.__)("module","qsa-engraving"):(0,l.__)("modules","qsa-engraving")," ",(0,l.__)("ready for engraving","qsa-engraving")," ","(",t," ",(0,l.__)("units","qsa-engraving"),")")),(0,n.createElement)("div",{className:"qsa-action-buttons"},(0,n.createElement)("button",{className:"button qsa-btn-clear",onClick:s,disabled:o},(0,l.__)("Clear Selection","qsa-engraving")),(0,n.createElement)("button",{className:"button button-primary qsa-btn-create",onClick:r,disabled:o},o?(0,n.createElement)(n.Fragment,null,(0,n.createElement)("span",{className:"spinner is-active"}),(0,l.__)("Creating...","qsa-engraving")):(0,n.createElement)(n.Fragment,null,(0,l.__)("Start Engraving","qsa-engraving"),(0,n.createElement)("span",{className:"dashicons dashicons-arrow-right-alt"}))))):(0,n.createElement)("div",{className:"qsa-action-bar"},(0,n.createElement)("div",{className:"qsa-action-info"},(0,n.createElement)("span",{className:"dashicons dashicons-list-view qsa-action-icon"}),(0,n.createElement)("span",{className:"qsa-action-text"},(0,l.__)("Modules Awaiting Engraving","qsa-engraving"))),(0,n.createElement)("button",{className:"button qsa-btn-refresh",onClick:c,title:(0,l.__)("Refresh module list","qsa-engraving")},(0,n.createElement)("span",{className:"dashicons dashicons-update"})))}const E={SOLO:"Star/O",CORE:"LUXEON C ES",EDGE:"LUXEON UV U1",STAR:"Cree XPG",NORD:"Nordic",ATOM:"Atomic",APEX:"Apex",PICO:"Pico",QUAD:"Quad"};function v(){const[e,a]=(0,s.useState)({}),[t,r]=(0,s.useState)(!0),[c,i]=(0,s.useState)(null),[d,m]=(0,s.useState)(new Set),[v,_]=(0,s.useState)({}),[q,h]=(0,s.useState)(new Set),[b,y]=(0,s.useState)(new Set),[N,S]=(0,s.useState)(!1),f=(0,s.useCallback)(async()=>{r(!0),i(null);try{const e=await o()({path:"/qsa-engraving/v1/modules/awaiting",method:"GET"});e.success&&e.data?a(e.data):i(e.message||(0,l.__)("Failed to load modules.","qsa-engraving"))}catch(e){try{const e=await w();e.success&&e.data?a(e.data):i(e.message||(0,l.__)("Failed to load modules.","qsa-engraving"))}catch(e){i((0,l.__)("Failed to connect to server.","qsa-engraving"))}}finally{r(!1)}},[]),w=async()=>{const e=new FormData;return e.append("action","qsa_get_modules_awaiting"),e.append("nonce",window.qsaEngraving?.nonce||""),(await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:e,credentials:"same-origin"})).json()};(0,s.useEffect)(()=>{f()},[f]);const C=(0,s.useMemo)(()=>{const a=[];return Object.values(e).forEach(e=>{e.modules.forEach(e=>{e.items.forEach(e=>{const t=`${e.production_batch_id}-${e.module_sku}-${e.order_id}`;a.push({id:t,module:e})})})}),a},[e]),k=(0,s.useCallback)(a=>{const t=new Set;return e[a]&&e[a].modules.forEach(e=>{e.items.forEach(e=>{t.add(`${e.production_batch_id}-${e.module_sku}-${e.order_id}`)})}),t},[e]),x=(0,s.useCallback)((a,t)=>{const n=new Set;if(e[a]){const s=e[a].modules.find(e=>e.order_id===t);s&&s.items.forEach(e=>{n.add(`${e.production_batch_id}-${e.module_sku}-${e.order_id}`)})}return n},[e]),T=(0,s.useCallback)(e=>{const a=k(e),t=[...a].filter(e=>d.has(e)).length;return 0===t?"none":t===a.size?"all":"partial"},[k,d]),O=(0,s.useCallback)((e,a)=>{const t=x(e,a),n=[...t].filter(e=>d.has(e)).length;return 0===n?"none":n===t.size?"all":"partial"},[x,d]),M=(0,s.useCallback)(e=>{h(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t})},[]),Q=(0,s.useCallback)(e=>{y(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t})},[]),$=(0,s.useCallback)(a=>{const t=k(a),n=T(a),s=new Set(d);if("all"===n)t.forEach(e=>s.delete(e));else if(t.forEach(e=>s.add(e)),h(e=>new Set([...e,a])),e[a]){const t=e[a].modules.map(e=>e.order_id);y(e=>new Set([...e,...t]))}m(s)},[k,T,e,d]),j=(0,s.useCallback)((e,a)=>{const t=x(e,a),n=O(e,a),s=new Set(d);"all"===n?t.forEach(e=>s.delete(e)):t.forEach(e=>s.add(e)),m(s)},[x,O,d]),U=(0,s.useCallback)(e=>{m(a=>{const t=new Set(a);return t.has(e)?t.delete(e):t.add(e),t})},[]),B=(0,s.useCallback)((e,a)=>void 0!==v[e]?v[e]:a,[v]),F=(0,s.useCallback)((e,a,t)=>{const n=parseInt(a,10)||0,s=Math.max(0,Math.min(n,t));_(a=>({...a,[e]:s})),0===s?m(a=>{const t=new Set(a);return t.delete(e),t}):d.has(e)||m(a=>new Set([...a,e]))},[d]),R=(0,s.useCallback)(()=>{m(new Set),_({})},[]),P=(0,s.useMemo)(()=>{let e=0,a=0;return C.forEach(({id:t,module:n})=>{d.has(t)&&(e++,a+=B(t,n.qty_to_engrave))}),{moduleCount:e,unitCount:a}},[C,d,B]),A=(0,s.useCallback)(async()=>{if(0===P.moduleCount)return;S(!0);const e=[];C.forEach(({id:a,module:t})=>{d.has(a)&&e.push({production_batch_id:t.production_batch_id,module_sku:t.module_sku,order_id:t.order_id,quantity:B(a,t.qty_to_engrave)})});try{const a=new FormData;a.append("action","qsa_create_batch"),a.append("nonce",window.qsaEngraving?.nonce||""),a.append("selections",JSON.stringify(e));const t=await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:a,credentials:"same-origin"}),n=await t.json();n.success?n.data?.redirect_url?window.location.href=n.data.redirect_url:(R(),f()):i(n.message||(0,l.__)("Failed to create batch.","qsa-engraving"))}catch(e){i((0,l.__)("Failed to create batch. Please try again.","qsa-engraving"))}finally{S(!1)}},[P,C,d,B,R,f]);if(t)return(0,n.createElement)("div",{className:"qsa-batch-creator qsa-loading"},(0,n.createElement)("span",{className:"spinner is-active"}),(0,n.createElement)("p",null,(0,l.__)("Loading modules...","qsa-engraving")));if(c)return(0,n.createElement)("div",{className:"qsa-batch-creator qsa-error"},(0,n.createElement)("div",{className:"notice notice-error"},(0,n.createElement)("p",null,c)),(0,n.createElement)("button",{className:"button",onClick:f},(0,l.__)("Retry","qsa-engraving")));const D=Object.keys(e).length>0;return(0,n.createElement)("div",{className:"qsa-batch-creator"},(0,n.createElement)(g,{baseTypeCount:Object.keys(e).length,selectedCount:P.moduleCount,unitCount:P.unitCount}),(0,n.createElement)(p,{hasSelection:P.moduleCount>0,moduleCount:P.moduleCount,unitCount:P.unitCount,onClear:R,onCreateBatch:A,creating:N,onRefresh:f}),D?(0,n.createElement)(u,{moduleData:e,baseTypeNames:E,selectedModules:d,expandedBaseTypes:q,expandedOrders:b,getBaseTypeSelectionState:T,getOrderSelectionState:O,toggleBaseTypeExpansion:M,toggleOrderExpansion:Q,toggleBaseTypeSelection:$,toggleOrderSelection:j,toggleModuleSelection:U,getEngraveQty:B,updateEngraveQty:F}):(0,n.createElement)("div",{className:"qsa-empty-state"},(0,n.createElement)("p",null,(0,l.__)("No modules awaiting engraving.","qsa-engraving")),(0,n.createElement)("button",{className:"button",onClick:f},(0,l.__)("Refresh","qsa-engraving"))))}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("qsa-engraving-batch-creator");e&&(0,s.createRoot)(e).render((0,n.createElement)(v,null))})}},t={};function n(e){var s=t[e];if(void 0!==s)return s.exports;var l=t[e]={exports:{}};return a[e](l,l.exports,n),l.exports}n.m=a,e=[],n.O=(a,t,s,l)=>{if(!t){var r=1/0;for(d=0;d<e.length;d++){for(var[t,s,l]=e[d],o=!0,c=0;c<t.length;c++)(!1&l||r>=l)&&Object.keys(n.O).every(e=>n.O[e](t[c]))?t.splice(c--,1):(o=!1,l<r&&(r=l));if(o){e.splice(d--,1);var i=s();void 0!==i&&(a=i)}}return a}l=l||0;for(var d=e.length;d>0&&e[d-1][2]>l;d--)e[d]=e[d-1];e[d]=[t,s,l]},n.n=e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return n.d(a,{a}),a},n.d=(e,a)=>{for(var t in a)n.o(a,t)&&!n.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:a[t]})},n.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),(()=>{var e={218:0,653:0};n.O.j=a=>0===e[a];var a=(a,t)=>{var s,l,[r,o,c]=t,i=0;if(r.some(a=>0!==e[a])){for(s in o)n.o(o,s)&&(n.m[s]=o[s]);if(c)var d=c(n)}for(a&&a(t);i<r.length;i++)l=r[i],n.o(e,l)&&e[l]&&e[l][0](),e[l]=0;return n.O(d)},t=globalThis.webpackChunkqsa_engraving=globalThis.webpackChunkqsa_engraving||[];t.forEach(a.bind(null,0)),t.push=a.bind(null,t.push.bind(t))})();var s=n.O(void 0,[653],()=>n(198));s=n.O(s)})();