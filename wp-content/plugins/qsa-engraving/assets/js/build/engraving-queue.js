(()=>{"use strict";var e,a={601(){const e=window.React,a=window.wp.element,s=window.wp.i18n;function t({batch:a,activeBatchCount:t=0}){const n=window.location.href.replace(/&batch_id=\d+/,"").replace(/\?batch_id=\d+&/,"?").replace(/\?batch_id=\d+$/,""),r=window.location.href.replace(/qsa-engraving-queue.*/,"qsa-engraving"),i=t>0?n:r,l=t>0?(0,s.__)("Back to Batch Selector","qsa-engraving"):(0,s.__)("Back to Dashboard","qsa-engraving");return(0,e.createElement)("div",{className:"qsa-queue-header"},(0,e.createElement)("div",{className:"qsa-queue-header-left"},(0,e.createElement)("a",{href:i,className:"qsa-back-button",title:l},(0,e.createElement)("span",{className:"dashicons dashicons-arrow-left-alt2"})),(0,e.createElement)("div",{className:"qsa-queue-header-icon"},(0,e.createElement)("span",{className:"dashicons dashicons-grid-view"})),(0,e.createElement)("div",{className:"qsa-queue-header-text"},(0,e.createElement)("h1",null,(0,s.__)("Engraving Queue","qsa-engraving")),(0,e.createElement)("p",null,a?.batch_name||(0,s.__)("Module Engraving Workflow","qsa-engraving")))),(0,e.createElement)("div",{className:"qsa-queue-header-right"},a&&(0,e.createElement)(e.Fragment,null,(0,e.createElement)("span",{className:"qsa-batch-id"},(0,s.__)("Batch","qsa-engraving")," #",a.id),(0,e.createElement)("span",{className:`qsa-batch-status status-${a.status}`},"in_progress"===a.status?(0,s.__)("In Progress","qsa-engraving"):"complete"===a.status||"completed"===a.status?(0,s.__)("Completed","qsa-engraving"):(0,s.__)("Pending","qsa-engraving")))))}function n({stats:a,capacity:t}){const n=a.totalModules>0?Math.round(a.completedModules/a.totalModules*100):0;return(0,e.createElement)("div",{className:"qsa-queue-stats"},(0,e.createElement)("div",{className:"qsa-stats-grid"},(0,e.createElement)("div",{className:"qsa-stat-item"},(0,e.createElement)("div",{className:"qsa-stat-label"},(0,s.__)("Queue Rows","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-stat-value"},a.totalItems)),(0,e.createElement)("div",{className:"qsa-stat-item"},(0,e.createElement)("div",{className:"qsa-stat-label"},(0,s.__)("Rows Done","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-stat-value"},(0,e.createElement)("span",{className:"qsa-stat-completed"},a.completedItems),(0,e.createElement)("span",{className:"qsa-stat-separator"},"/"),(0,e.createElement)("span",{className:"qsa-stat-total"},a.totalItems))),(0,e.createElement)("div",{className:"qsa-stat-item"},(0,e.createElement)("div",{className:"qsa-stat-label"},(0,s.__)("Modules","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-stat-value"},(0,e.createElement)("span",{className:"qsa-stat-completed"},a.completedModules),(0,e.createElement)("span",{className:"qsa-stat-separator"},"/"),(0,e.createElement)("span",{className:"qsa-stat-total"},a.totalModules))),(0,e.createElement)("div",{className:"qsa-stat-item"},(0,e.createElement)("div",{className:"qsa-stat-label"},(0,s.__)("Progress","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-stat-value qsa-stat-progress"},n,"%"))),(0,e.createElement)("div",{className:"qsa-progress-bar-container"},(0,e.createElement)("div",{className:"qsa-progress-bar-bg"},(0,e.createElement)("div",{className:"qsa-progress-bar",style:{width:`${n}%`}}))),t&&t.warning&&(0,e.createElement)("div",{className:"qsa-capacity-warning "+(t.critical?"critical":"")},(0,e.createElement)("span",{className:"dashicons dashicons-warning"}),(0,e.createElement)("span",null,t.critical?(0,s.__)("Critical: Serial capacity critically low!","qsa-engraving"):(0,s.__)("Warning: Serial capacity running low.","qsa-engraving")," ",t.remaining.toLocaleString()," ",(0,s.__)("remaining","qsa-engraving"))))}function r(e){return e?.padStart(8,"0")||"--------"}function i({item:t,isLast:n,isActive:i,currentArray:l=1,isResending:c=!1,isUpdatingStartPosition:o=!1,isProcessingNextArray:d=!1,onStart:m,onComplete:g,onNextArray:u,onResend:q,onRerun:p,onStartPositionChange:_}){const[v,h]=(0,a.useState)(t.startPosition||1),E=t.completedArrays||0,N=function(e,a=0){switch(e){case"complete":return{className:"status-complete",text:(0,s.__)("Complete","qsa-engraving")};case"in_progress":return{className:"status-in-progress",text:(0,s.__)("In Progress","qsa-engraving")};case"partial":return{className:"status-partial",text:a>0?`${a} ${(0,s.__)("array(s) done","qsa-engraving")}`:(0,s.__)("Partial","qsa-engraving")};default:return{className:"status-pending",text:(0,s.__)("Pending","qsa-engraving")}}}(t.status,E),b=t.qsa_sequences||[t.id],f=function(e,a,s=[]){const t=[];let n=e,r=0;if(a>1){const e=Math.min(n,9-a),i=s.slice(r,r+e);t.push({arrayNum:1,startPos:a,endPos:a+e-1,moduleCount:e,serialStart:i[0]?.serial_number||null,serialEnd:i[i.length-1]?.serial_number||null,description:`${a}-${a+e-1}`}),r+=e,n-=e}for(;n>0;){const e=Math.min(n,8),a=e,i=s.slice(r,r+e);t.push({arrayNum:t.length+1,startPos:1,endPos:a,moduleCount:e,serialStart:i[0]?.serial_number||null,serialEnd:i[i.length-1]?.serial_number||null,description:`1-${a}`}),r+=e,n-=e}return t}(t.totalModules,v,t.serials||[]),w=f.length,y=l>=w,S=f[l-1]||null,k=t.serials&&t.serials.length>0?{start:t.serials[0]?.serial_number,end:t.serials[t.serials.length-1]?.serial_number}:null;return(0,e.createElement)("div",{className:`qsa-queue-item ${"in_progress"===t.status?"is-active":""} ${n?"is-last":""}`},(0,e.createElement)("div",{className:"qsa-queue-item-header"},(0,e.createElement)("div",{className:"qsa-queue-item-left"},(0,e.createElement)("div",{className:`qsa-status-icon ${N.className}`},"complete"===t.status&&(0,e.createElement)("span",{className:"dashicons dashicons-yes-alt"}),"in_progress"===t.status&&(0,e.createElement)("span",{className:"dashicons dashicons-update spin"}),"partial"===t.status&&(0,e.createElement)("span",{className:"dashicons dashicons-marker"}),"pending"===t.status&&(0,e.createElement)("span",{className:"dashicons dashicons-clock"})),(0,e.createElement)("span",{className:"qsa-base-type-badge"},t.baseType),(0,e.createElement)("span",{className:"qsa-module-summary"},t.totalModules," ",(0,s.__)("modules","qsa-engraving")),(0,e.createElement)("span",{className:`qsa-status-badge ${N.className}`},N.text)),(0,e.createElement)("div",{className:"qsa-queue-item-right"},"pending"===t.status&&(0,e.createElement)("button",{type:"button",className:"qsa-btn-start "+(o?"is-loading":""),onClick:()=>m(t.id),disabled:o,title:o?(0,s.__)("Please wait while start position is being updated...","qsa-engraving"):(0,s.__)("Start engraving this row","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons "+(o?"dashicons-update spin":"dashicons-controls-play")}),o?(0,s.__)("Updating...","qsa-engraving"):(0,s.__)("Engrave","qsa-engraving")),"partial"===t.status&&(0,e.createElement)("div",{className:"qsa-action-buttons"},(0,e.createElement)("button",{type:"button",className:"qsa-btn-resume",onClick:()=>m(t.id),title:(0,s.__)("Resume engraving from where you left off","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons dashicons-controls-play"}),(0,s.__)("Resume","qsa-engraving")),(0,e.createElement)("button",{type:"button",className:"qsa-btn-rerun",onClick:()=>p(t.id),title:(0,s.__)("Reset and start over from beginning","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons dashicons-controls-repeat"}),(0,s.__)("Rerun","qsa-engraving"))),"in_progress"===t.status&&(0,e.createElement)("div",{className:"qsa-action-buttons"},(0,e.createElement)("button",{type:"button",className:"qsa-btn-resend "+(c?"is-loading":""),onClick:()=>q(t.id,l),disabled:c,title:(0,s.__)("Resend current SVG to laser (same serials)","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons dashicons-update "+(c?"spin":"")}),c?(0,s.__)("Sending...","qsa-engraving"):(0,s.__)("Resend","qsa-engraving")),y?(0,e.createElement)("button",{type:"button",className:"qsa-btn-complete",onClick:()=>g(t.id)},(0,e.createElement)("span",{className:"dashicons dashicons-yes"}),(0,s.__)("Complete","qsa-engraving")):(0,e.createElement)("button",{type:"button",className:"qsa-btn-next-array "+(d?"is-loading":""),onClick:()=>u(t.id,l),disabled:d,title:d?(0,s.__)("Processing...","qsa-engraving"):(0,s.__)("Press SPACEBAR or click","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons "+(d?"dashicons-update spin":"dashicons-arrow-right-alt2")}),d?(0,s.__)("Processing...","qsa-engraving"):(0,s.__)("Next Array","qsa-engraving"))),"complete"===t.status&&(0,e.createElement)("div",{className:"qsa-action-buttons"},(0,e.createElement)("button",{type:"button",className:"qsa-btn-rerun",onClick:()=>p(t.id),title:(0,s.__)("Rerun engraving from beginning","qsa-engraving")},(0,e.createElement)("span",{className:"dashicons dashicons-controls-repeat"}),(0,s.__)("Rerun","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-done-badge"},(0,e.createElement)("span",{className:"dashicons dashicons-yes-alt"}),(0,s.__)("Done","qsa-engraving"))))),(0,e.createElement)("div",{className:"qsa-queue-item-details"},(0,e.createElement)("div",{className:"qsa-detail-group"},(0,e.createElement)("span",{className:"dashicons dashicons-editor-code"}),(0,e.createElement)("span",{className:"qsa-detail-label"},(0,s.__)("Modules:","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-modules-list"},t.modules.map((a,s)=>(0,e.createElement)("span",{key:s,className:"qsa-module-sku"},(0,e.createElement)("a",{href:`${window.qsaEngraving?.adminUrl||"/wp-admin/"}edit.php?post_type=product&s=${encodeURIComponent(a.sku)}`,className:"qsa-link",target:"_blank",rel:"noopener noreferrer"},a.sku)," ","Ã—",a.qty))))),(0,e.createElement)("div",{className:"qsa-queue-item-stats"},(0,e.createElement)("div",{className:"qsa-stat-group"},(0,e.createElement)("span",{className:"qsa-stat-label"},(0,s.__)("Arrays:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-stat-value"},w)),(0,e.createElement)("div",{className:"qsa-stat-group"},(0,e.createElement)("span",{className:"qsa-stat-label"},(0,s.__)("Total Modules:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-stat-value"},t.totalModules)),(0,e.createElement)("div",{className:"qsa-stat-group"},(0,e.createElement)("span",{className:"qsa-stat-label"},(0,s.__)("Start Position:","qsa-engraving")),(0,e.createElement)("input",{type:"number",min:"1",max:"8",value:v,onChange:e=>{const a=parseInt(e.target.value,10);a>=1&&a<=8&&(h(a),_(t.id,a))},disabled:"pending"!==t.status||o,className:"qsa-start-position-input "+(o?"is-loading":""),title:o?(0,s.__)("Updating start position...","qsa-engraving"):(0,s.__)("Starting position on array (1-8)","qsa-engraving")})),k&&(0,e.createElement)("div",{className:"qsa-stat-group"},(0,e.createElement)("span",{className:"qsa-stat-label"},(0,s.__)("Serials:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-serial-range"},r(k.start)," - ",r(k.end)))),"in_progress"===t.status&&S&&(0,e.createElement)("div",{className:"qsa-in-progress-details"},(0,e.createElement)("div",{className:"qsa-progress-indicator"},(0,e.createElement)("div",{className:"qsa-progress-indicator-left"},(0,e.createElement)("div",{className:"qsa-progress-badge"},(0,e.createElement)("span",{className:"dashicons dashicons-grid-view"}),(0,e.createElement)("span",null,(0,s.__)("Array","qsa-engraving")," ",l," ",(0,s.__)("of","qsa-engraving")," ",w)),(0,e.createElement)("div",{className:"qsa-progress-info"},(0,e.createElement)("span",{className:"qsa-info-label"},(0,s.__)("Positions:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-info-value"},S.startPos," - ",S.endPos)),(0,e.createElement)("div",{className:"qsa-progress-info"},(0,e.createElement)("span",{className:"qsa-info-label"},(0,s.__)("Modules:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-info-value"},S.moduleCount)),S.serialStart&&(0,e.createElement)("div",{className:"qsa-progress-info"},(0,e.createElement)("span",{className:"qsa-info-label"},(0,s.__)("Serials:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-serial-range-active"},r(S.serialStart)," - ",r(S.serialEnd))),t.qsaId&&(0,e.createElement)("div",{className:"qsa-progress-info qsa-id-info"},(0,e.createElement)("span",{className:"qsa-info-label"},(0,s.__)("QSA ID:","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-id-badge"},t.qsaId))),(0,e.createElement)("div",{className:"qsa-progress-dots"},b.map((a,s)=>(0,e.createElement)("div",{key:s,className:"qsa-progress-dot "+(s<l-1?"completed":s===l-1?"current":"")}))))))}function l(){const e=new URLSearchParams(window.location.search).get("batch_id");return e?parseInt(e,10):null}function c(){var r,c;const[o,d]=(0,a.useState)(l),[m,g]=(0,a.useState)(null),[u,q]=(0,a.useState)([]),[p,_]=(0,a.useState)(null),[v,h]=(0,a.useState)(!0),[E,N]=(0,a.useState)(null),[b,f]=(0,a.useState)(null),[w,y]=(0,a.useState)([]),[S,k]=(0,a.useState)(0),[P,x]=(0,a.useState)(!1),[C,A]=(0,a.useState)({}),[M,R]=(0,a.useState)(null),[I,F]=(0,a.useState)(null),[$,O]=(0,a.useState)(null),B=(0,a.useRef)(!1),[j,L]=(0,a.useState)({enabled:null!==(r=window.qsaEngraving?.lightburnEnabled)&&void 0!==r&&r,autoLoad:null===(c=window.qsaEngraving?.lightburnAutoLoad)||void 0===c||c,connected:!1,loading:!1,lastFile:null}),D=e=>C[e]||1,T=(0,a.useCallback)(async()=>{try{const e=new FormData;e.append("action","qsa_get_active_batches"),e.append("nonce",window.qsaEngraving?.nonce||"");const a=await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:e}),t=await a.json();t.success?(y(t.data.batches),0===t.data.batches.length?N((0,s.__)("No active batches found. Create a new batch first.","qsa-engraving")):x(!0)):N(t.message||(0,s.__)("Failed to load active batches.","qsa-engraving"))}catch(e){N((0,s.__)("Network error loading active batches.","qsa-engraving"))}h(!1)},[]),U=(0,a.useCallback)(async()=>{if(o){try{const e=new FormData;e.append("action","qsa_get_queue"),e.append("nonce",window.qsaEngraving?.nonce||""),e.append("batch_id",o);const a=await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:e}),t=await a.json();if(t.success){g(t.data.batch),q(t.data.queue_items),_(t.data.capacity),k(t.data.active_batch_count||0),N(null),x(!1);const e={};let a=null;t.data.queue_items.forEach(s=>{"in_progress"===s.status&&s.currentArray>0?(e[s.id]=s.currentArray,a=s.id):"partial"===s.status&&s.completedArrays>0&&(e[s.id]=s.completedArrays+1)}),Object.keys(e).length>0&&A(e),a&&f(a)}else N(t.message||(0,s.__)("Failed to load queue.","qsa-engraving"))}catch(e){N((0,s.__)("Network error loading queue.","qsa-engraving"))}h(!1)}else T()},[o,T]),G=e=>{const a=new URL(window.location.href);a.searchParams.set("batch_id",e),window.history.pushState({},"",a.toString()),d(e),x(!1),h(!0)};(0,a.useEffect)(()=>{U()},[U]),(0,a.useEffect)(()=>{if(u.length>0&&null===b){const e=u.find(e=>"in_progress"===e.status);e&&f(e.id)}},[u,b]);const V=async(e,a={})=>{const s=new FormData;return s.append("action",e),s.append("nonce",window.qsaEngraving?.nonce||""),s.append("batch_id",o),Object.entries(a).forEach(([e,a])=>{s.append(e,a)}),(await fetch(window.qsaEngraving?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",body:s})).json()},Q=async(e,a,t=!0)=>{try{L(e=>({...e,loading:!0}));const n=await V("qsa_generate_svg",{qsa_sequence:e,auto_load:t&&j.enabled?"1":"0"});return n.success?(L(e=>({...e,loading:!1,lastFile:n.data.filename,connected:n.data.lightburn_loaded||e.connected})),n.data.qsa_id&&a&&q(e=>e.map(e=>e.id===a?{...e,qsaId:n.data.qsa_id}:e)),{success:!0,data:n.data}):(L(e=>({...e,loading:!1})),{success:!1,error:n.message||(0,s.__)("SVG generation failed.","qsa-engraving")})}catch(e){return L(e=>({...e,loading:!1})),{success:!1,error:(0,s.__)("Network error generating SVG.","qsa-engraving")}}},W=(e,a)=>{const s=e.qsa_sequences||[e.id];return a<1||a>s.length?(console.error(`Invalid array index ${a} for item with ${s.length} sequences`),null):s[a-1]},K=async e=>{const a=u.find(a=>a.id===e);if(!a)return;let t;if("pending"===a.status)t=1;else if(a.nextPendingArray>0)t=a.nextPendingArray;else{if("partial"===a.status&&0===a.nextPendingArray)return void alert((0,s.__)("No pending arrays found. This may be due to a previous error.","qsa-engraving")+"\n\n"+(0,s.__)("Please use Rerun to reset this row and start over.","qsa-engraving"));{const e=a.completedArrays||0;t=e+1}}const n=W(a,t);if(null!==n)try{const a=await V("qsa_start_row",{qsa_sequence:n});if(a.success){var r;f(e),A(a=>({...a,[e]:t})),q(s=>s.map(s=>s.id===e?{...s,status:"in_progress",serials:a.data.serials,qsaId:null}:s));const i=null!==(r=window.qsaEngraving?.keepSvgFiles)&&void 0!==r&&r;if(j.enabled||i){const a=j.enabled&&j.autoLoad,t=await Q(n,e,a);t.success?t.data&&!t.data.lightburn_loaded&&a&&console.warn("SVG generated but LightBurn load failed:",t.data.lightburn_error):alert((0,s.__)("Row started but SVG generation failed:","qsa-engraving")+"\n\n"+t.error+"\n\n"+(0,s.__)("Please resolve the issue and use Resend to regenerate the SVG.","qsa-engraving"))}}else alert(a.message||(0,s.__)("Failed to start row.","qsa-engraving"))}catch(e){alert((0,s.__)("Network error starting row.","qsa-engraving"))}else alert((0,s.__)("Invalid array state. The starting array index is out of sync with available sequences.","qsa-engraving")+"\n\n"+(0,s.__)("Please refresh the page and try again.","qsa-engraving"))},z=async e=>{const a=u.find(a=>a.id===e);if(!a)return;const t=D(e),n=W(a,t);if(null!==n)try{const a=await V("qsa_complete_row",{qsa_sequence:n});a.success?(f(null),A(a=>({...a,[e]:0})),q(a=>a.map(a=>a.id===e?{...a,status:"complete"}:a)),a.data.batch_complete&&g(e=>({...e,status:"completed"}))):alert(a.message||(0,s.__)("Failed to complete row.","qsa-engraving"))}catch(e){alert((0,s.__)("Network error completing row.","qsa-engraving"))}else alert((0,s.__)("Invalid array state. The current array index is out of sync.","qsa-engraving")+"\n\n"+(0,s.__)("Please refresh the page and try again.","qsa-engraving"))},H=async(e,a)=>{if(B.current)return;B.current=!0;const t=u.find(a=>a.id===e);if(!t)return void(B.current=!1);O(e),t.qsa_sequences||t.id;const n=9-(t.startPosition||1),r=Math.max(0,t.totalModules-n),i=1+Math.ceil(r/8),l=a+1;if(l>i)return void z(e);const c=W(t,a),o=W(t,l);if(null!==c&&null!==o)try{const t=await V("qsa_complete_row",{qsa_sequence:c});if(!t.success)return void alert(t.message||(0,s.__)("Failed to complete current array.","qsa-engraving"));const n=await V("qsa_start_row",{qsa_sequence:o});if(n.success){var d;A(a=>({...a,[e]:l})),q(s=>s.map(s=>s.id===e?{...s,serials:n.data.serials,qsaId:null,completedArrays:a,status:"in_progress"}:s));const t=null!==(d=window.qsaEngraving?.keepSvgFiles)&&void 0!==d&&d;if(j.enabled||t){const a=j.enabled&&j.autoLoad,t=await Q(o,e,a);t.success||alert((0,s.__)("Array started but SVG generation failed:","qsa-engraving")+"\n\n"+t.error+"\n\n"+(0,s.__)("Use Resend to try again.","qsa-engraving"))}}else alert(n.message||(0,s.__)("Failed to start next array.","qsa-engraving"))}catch(e){alert((0,s.__)("Network error advancing to next array.","qsa-engraving"))}finally{B.current=!1,O(null)}else alert((0,s.__)("Invalid array state. The current array index is out of sync.","qsa-engraving")+"\n\n"+(0,s.__)("Please refresh the page and try again.","qsa-engraving"))},J=async e=>{const a=u.find(a=>a.id===e);if(!a)return;const t=D(e),n=W(a,t);if(null!==n)try{R(e),L(e=>({...e,loading:!0}));const a=await V("qsa_load_svg",{qsa_sequence:n});if(a.success)L(e=>({...e,loading:!1,lastFile:a.data.filename,connected:!0}));else{const a=await Q(n,e,!0);a.success?L(e=>({...e,loading:!1})):(L(e=>({...e,loading:!1})),alert((0,s.__)("Failed to regenerate SVG:","qsa-engraving")+"\n\n"+a.error+"\n\n"+(0,s.__)("Please resolve the issue and try again.","qsa-engraving")))}}catch(e){L(e=>({...e,loading:!1})),alert((0,s.__)("Network error during resend.","qsa-engraving"))}finally{R(null)}else alert((0,s.__)("Invalid array state. The current array index is out of sync.","qsa-engraving")+"\n\n"+(0,s.__)("Please refresh the page and try again.","qsa-engraving"))},X=async e=>{if(!confirm((0,s.__)("This will reset this row to pending for re-engraving. Continue?","qsa-engraving")))return;const a=u.find(a=>a.id===e);if(!a)return;const t=a.qsa_sequences||[a.id];try{for(const e of t){const a=await V("qsa_rerun_row",{qsa_sequence:e});if(!a.success)return void alert(a.message||(0,s.__)("Failed to rerun.","qsa-engraving"))}A(a=>({...a,[e]:0})),q(a=>a.map(a=>a.id===e?{...a,status:"pending",serials:[],completedArrays:0}:a))}catch(e){alert((0,s.__)("Network error during rerun.","qsa-engraving"))}},Y=async(e,a)=>{const t=u.find(a=>a.id===e);if(!t)return;const n=(t.qsa_sequences||[t.id])[0];F(e);try{const t=await V("qsa_update_start_position",{qsa_sequence:n,start_position:a});t.success?q(s=>s.map(s=>s.id===e?{...s,startPosition:a,qsa_sequences:t.data.qsa_sequences||s.qsa_sequences}:s)):alert(t.message||(0,s.__)("Failed to update start position.","qsa-engraving"))}catch(e){alert((0,s.__)("Network error updating start position.","qsa-engraving"))}finally{F(null)}},Z={totalItems:u.length,completedItems:u.filter(e=>"complete"===e.status).length,totalModules:u.reduce((e,a)=>e+a.totalModules,0),completedModules:u.reduce((e,a)=>e+(e=>{if("complete"===e.status)return e.totalModules;if("pending"===e.status||!e.completedArrays||0===e.completedArrays)return 0;const a=e.startPosition||1,s=e.totalModules||0,t=e.completedArrays||0;if(t>=(e.arrayCount||1))return s;const n=Math.min(9-a,s);let r=0;for(let e=0;e<t;e++)if(0===e)r+=n;else{const a=s-n,t=Math.min(8,a-8*(e-1));r+=Math.max(0,t)}return Math.min(r,s)})(a),0)};if(v)return(0,e.createElement)("div",{className:"qsa-engraving-queue"},(0,e.createElement)("div",{className:"qsa-queue-loading"},(0,e.createElement)("span",{className:"spinner is-active"}),(0,e.createElement)("p",null,(0,s.__)("Loading engraving queue...","qsa-engraving"))));const ee=window.location.href.replace(/qsa-engraving-queue.*/,"qsa-engraving");return E?(0,e.createElement)("div",{className:"qsa-engraving-queue"},(0,e.createElement)("div",{className:"qsa-queue-error"},(0,e.createElement)("div",{className:"notice notice-error"},(0,e.createElement)("p",null,E)),(0,e.createElement)("div",{className:"qsa-batch-selector-actions"},(0,e.createElement)("a",{href:ee,className:"button"},(0,e.createElement)("span",{className:"dashicons dashicons-arrow-left-alt2"}),(0,s.__)("Back to Dashboard","qsa-engraving")),(0,e.createElement)("a",{href:window.location.href.replace(/&batch_id=\d+/,"").replace(/\?page=/,"?page=qsa-engraving-batch-creator&_from="),className:"button button-primary"},(0,e.createElement)("span",{className:"dashicons dashicons-plus-alt2"}),(0,s.__)("Create New Batch","qsa-engraving"))))):P?(0,e.createElement)("div",{className:"qsa-engraving-queue"},(0,e.createElement)("div",{className:"qsa-batch-selector"},(0,e.createElement)("div",{className:"qsa-batch-selector-header"},(0,e.createElement)("span",{className:"dashicons dashicons-list-view"}),(0,e.createElement)("h2",null,(0,s.__)("Select an Active Batch","qsa-engraving"))),(0,e.createElement)("p",{className:"qsa-batch-selector-desc"},(0,s.__)("Choose a batch to continue engraving, or create a new batch.","qsa-engraving")),(0,e.createElement)("div",{className:"qsa-batch-selector-list"},w.map(a=>{return(0,e.createElement)("div",{key:a.id,className:"qsa-batch-selector-item",onClick:()=>G(a.id),onKeyDown:e=>"Enter"===e.key&&G(a.id),role:"button",tabIndex:0},(0,e.createElement)("div",{className:"qsa-batch-selector-item-header"},(0,e.createElement)("span",{className:"qsa-batch-id"},(0,s.__)("Batch","qsa-engraving")," #",a.id),a.batch_name&&(0,e.createElement)("span",{className:"qsa-batch-name"},a.batch_name)),(0,e.createElement)("div",{className:"qsa-batch-selector-item-meta"},(0,e.createElement)("span",{className:"qsa-batch-modules"},(0,e.createElement)("span",{className:"dashicons dashicons-screenoptions"}),a.module_count," ",(0,s.__)("modules","qsa-engraving")),(0,e.createElement)("span",{className:"qsa-batch-date"},(0,e.createElement)("span",{className:"dashicons dashicons-calendar-alt"}),(t=a.created_at)?new Date(t).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):""),a.created_by_name&&(0,e.createElement)("span",{className:"qsa-batch-creator"},(0,e.createElement)("span",{className:"dashicons dashicons-admin-users"}),a.created_by_name)),(0,e.createElement)("div",{className:"qsa-batch-selector-item-progress"},(0,e.createElement)("div",{className:"qsa-progress-bar"},(0,e.createElement)("div",{className:"qsa-progress-fill",style:{width:`${a.progress_percent}%`}}))));var t})),(0,e.createElement)("div",{className:"qsa-batch-selector-actions"},(0,e.createElement)("a",{href:ee,className:"button"},(0,e.createElement)("span",{className:"dashicons dashicons-arrow-left-alt2"}),(0,s.__)("Back to Dashboard","qsa-engraving")),(0,e.createElement)("a",{href:window.location.href.replace("qsa-engraving-queue","qsa-engraving-batch-creator"),className:"button button-primary"},(0,e.createElement)("span",{className:"dashicons dashicons-plus-alt2"}),(0,s.__)("Create New Batch","qsa-engraving"))))):(0,e.createElement)("div",{className:"qsa-engraving-queue"},(0,e.createElement)(t,{batch:m,activeBatchCount:S}),(0,e.createElement)(n,{stats:Z,capacity:p}),(0,e.createElement)("div",{className:"qsa-queue-list"},(0,e.createElement)("div",{className:"qsa-queue-list-header"},(0,e.createElement)("span",{className:"dashicons dashicons-list-view"}),(0,e.createElement)("span",{className:"qsa-queue-list-title"},(0,s.__)("Array Engraving Queue","qsa-engraving"))),(0,e.createElement)("div",{className:"qsa-queue-items"},u.map((a,s)=>(0,e.createElement)(i,{key:a.id,item:a,isLast:s===u.length-1,isActive:b===a.id,currentArray:D(a.id),isResending:M===a.id,isUpdatingStartPosition:I===a.id,isProcessingNextArray:$===a.id,onStart:K,onComplete:z,onNextArray:H,onResend:J,onRerun:X,onStartPositionChange:Y})))))}document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("qsa-engraving-engraving-queue");s&&(0,a.createRoot)(s).render((0,e.createElement)(c,null))})}},s={};function t(e){var n=s[e];if(void 0!==n)return n.exports;var r=s[e]={exports:{}};return a[e](r,r.exports,t),r.exports}t.m=a,e=[],t.O=(a,s,n,r)=>{if(!s){var i=1/0;for(d=0;d<e.length;d++){for(var[s,n,r]=e[d],l=!0,c=0;c<s.length;c++)(!1&r||i>=r)&&Object.keys(t.O).every(e=>t.O[e](s[c]))?s.splice(c--,1):(l=!1,r<i&&(i=r));if(l){e.splice(d--,1);var o=n();void 0!==o&&(a=o)}}return a}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[s,n,r]},t.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),(()=>{var e={470:0,861:0};t.O.j=a=>0===e[a];var a=(a,s)=>{var n,r,[i,l,c]=s,o=0;if(i.some(a=>0!==e[a])){for(n in l)t.o(l,n)&&(t.m[n]=l[n]);if(c)var d=c(t)}for(a&&a(s);o<i.length;o++)r=i[o],t.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return t.O(d)},s=globalThis.webpackChunkqsa_engraving=globalThis.webpackChunkqsa_engraving||[];s.forEach(a.bind(null,0)),s.push=a.bind(null,s.push.bind(s))})();var n=t.O(void 0,[861],()=>t(601));n=t.O(n)})();